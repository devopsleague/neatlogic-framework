<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="codedriver.framework.matrix.dao.mapper.MatrixAttributeMapper">
    <select id="getMatrixAttributeByMatrixUuid" parameterType="string"
            resultType="codedriver.framework.matrix.dto.MatrixAttributeVo">
        SELECT `uuid`,
               `matrix_uuid` AS matrixUuid,
               `name`,
               `type`,
               `is_required` AS isRequired,
               `sort`,
               `config`
        FROM `matrix_attribute`
        WHERE `matrix_uuid` = #{matrixUuid}
        ORDER BY `sort`
    </select>

    <delete id="deleteAttributeByMatrixUuid" parameterType="string">
        DELETE
        FROM `matrix_attribute`
        WHERE `matrix_uuid` = #{matrixUuid}
    </delete>

    <insert id="insertMatrixAttribute" parameterType="codedriver.framework.matrix.dto.MatrixAttributeVo">
        INSERT INTO `matrix_attribute` (`matrix_uuid`,
                                                `uuid`,
                                                `name`,
                                                `type`,
                                                `is_required`,
                                                `sort`,
                                                `config`)
        VALUES (#{matrixUuid},
                #{uuid},
                #{name},
                #{type},
                #{isRequired},
                #{sort},
                #{config})
    </insert>

    <update id="createMatrixDynamicTable">
        CREATE table `${schemaName}`.`matrix_${matrixUuid}` (
        `id` bigint(20) NOT NULL AUTO_INCREMENT,
        `uuid` char(32) NOT NULL,
        <foreach collection="attributeList" item="attribute" separator="," index="index">
            `${attribute.uuid}` varchar(100) DEFAULT NULL
        </foreach>
        ,PRIMARY KEY (`uuid`),
        KEY `id`(`id`)
        )ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4

    </update>

    <update id="dropMatrixDynamicTable" parameterType="string">
        DROP TABLE IF EXISTS `${schemaName}`.`matrix_${matrixUuid}`
    </update>

    <update id="addMatrixDynamicTableColumn">
        ALTER TABLE `${schemaName}`.`matrix_${matrixUuid}` ADD COLUMN `${columnName}` VARCHAR (100)
    </update>

    <update id="dropMatrixDynamicTableColumn">
        ALTER TABLE `${schemaName}`.`matrix_${matrixUuid}` DROP COLUMN `${columnName}`
    </update>
</mapper>